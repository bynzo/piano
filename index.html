<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piano Starter - No Armure, Random Accidentals</title>
  <!-- Tone.js for audio -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <!-- VexFlow 1.2.93 (defines Vex.Flow) -->
  <script src="https://unpkg.com/vexflow@1.2.93/releases/vexflow-min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
    }
    header {
      background: #333;
      color: #fff;
      padding: 15px;
      text-align: center;
    }
    nav {
      text-align: center;
      margin: 15px 0;
    }
    nav button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .section {
      display: none;
    }
    .active {
      display: block;
    }
    h2 {
      text-align: center;
    }
    /* Theory Section */
    details {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    details summary {
      font-size: 18px;
      cursor: pointer;
    }
    .quiz p {
      margin: 10px 0 5px;
      font-weight: bold;
    }
    .quiz button {
      margin: 5px 5px 5px 0;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* Practice Section */
    .exercise {
      text-align: center;
      margin-bottom: 20px;
    }
    .exercise p {
      font-size: 18px;
    }
    .message {
      font-size: 18px;
      margin-top: 10px;
      text-align: center;
    }
    /* Staff */
    #staffContainer {
      margin: 20px auto;
      width: 520px;
      height: 300px;
      border: 1px solid #ccc;
      background: #fff;
    }
    /* Keyboard */
    #pianoContainer {
      margin: 30px auto;
      overflow-x: auto;
      width: 100%;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    #pianoKeys {
      position: relative;
      height: 200px;
      width: 3000px; /* Enough for C2..C6 */
    }
    .white-key {
      position: absolute;
      width: 60px;
      height: 200px;
      border: 1px solid #000;
      background: #fff;
      box-sizing: border-box;
      z-index: 1;
      cursor: pointer;
    }
    .white-key:active {
      background: #ddd;
    }
    .black-key {
      position: absolute;
      width: 40px;
      height: 120px;
      background: #000;
      color: #fff;
      text-align: center;
      line-height: 120px;
      z-index: 2;
      cursor: pointer;
      border: 1px solid #333;
    }
    .black-key:active {
      background: #555;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      background: #333;
      color: #fff;
    }
  </style>
</head>

<body>
  <header>
    <h1>Piano Starter - No Armure, Random Accidentals</h1>
  </header>

  <nav>
    <button id="theoryTab">Théorie</button>
    <button id="practiceTab">Pratique</button>
  </nav>

  <div class="container">
    <!-- Theory Section -->
    <div id="theorySection" class="section active">
      <h2>Théorie Musicale</h2>
      <p>Intégrez vos leçons de solfège, etc.</p>
      <details>
        <summary>Lecture de partition (Clés de sol et de fa)</summary>
        <p>En clé de sol, la 2ème ligne représente le Sol. En clé de fa, la 4ème ligne représente le Fa.</p>
        <div class="quiz">
          <p>Question : En clé de sol, quelle note se trouve sur la 2ème ligne ?</p>
          <button onclick="checkQuizAnswer('q1', 'G')">G</button>
          <button onclick="checkQuizAnswer('q1', 'A')">A</button>
          <button onclick="checkQuizAnswer('q1', 'C')">C</button>
          <button onclick="checkQuizAnswer('q1', 'D')">D</button>
          <p id="q1"></p>
        </div>
      </details>
    </div>

    <!-- Practice Section -->
    <div id="practiceSection" class="section">
      <h2>Pratique</h2>
      <div class="exercise">
        <p>Jouez les 4 notes affichées sur la partition :</p>
        <p>(Bass: C2–E4, Treble: A3–C6, random accidentals, 4 notes total, no armure.)</p>
        <button id="newExerciseBtn">Nouvelle Série</button>
        <p class="message" id="message"></p>
      </div>
      <div id="staffContainer"></div>
      <div id="pianoContainer">
        <div id="pianoKeys"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>Piano Starter &copy; 2025</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      /**********************************************
       * GLOBALS
       **********************************************/
      let exerciseNotes = []; // We'll store the 4 notes here
      const VF = Vex.Flow;
      const synth = new Tone.Synth().toDestination();

      // letter->semitone
      const letterToSemitone = {
        "C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11,
        // For flats
        "Bb":10
      };
      // semitone->sharp
      const semitoneToSharp = {
        0:"C",1:"C#",2:"D",3:"D#",4:"E",5:"F",6:"F#",7:"G",
        8:"G#",9:"A",10:"A#",11:"B"
      };

      // Probability-based accidental insertion
      const allowedSharps = ["C","D","F","G","A"];
      const allowedFlats  = ["D","E","G","A","B"];

      // Convert spelled => vexflow format
      function convertNoteFormat(noteStr){
        return noteStr.replace(/([A-G])(#?)(\d)/,(m,p1,p2,p3)=>{
          return p1.toLowerCase()+p2+"/"+p3;
        });
      }

      // Helper: parse a note => numeric value
      function noteToValue(n) {
        const m = n.match(/([A-G]#?)(\d)/);
        if (!m) return -1;
        let spelled = m[1];
        let oct = parseInt(m[2],10);
        let sem = letterToSemitone[spelled] || 0;
        return 12*oct + sem;
      }

      // Maybe add an accidental if the base note is truly natural
      function maybeAddAccidental(note){
        // If note already has # or b, skip (avoid double-sharp or double-flat)
        if (note.includes("#") || note.includes("b")) {
          return { display: note, actual: note };
        }
        // 50% chance
        if (Math.random()<0.5){
          let letter = note.charAt(0);
          // 50% chance for sharp vs. flat
          if (Math.random()<0.5 && allowedSharps.includes(letter)) {
            // e.g. "F4" => "F#4"
            return { display: letter+"#"+note.slice(1), actual: letter+"#"+note.slice(1) };
          } else if (allowedFlats.includes(letter)) {
            // e.g. "E4" => "Eb4" displayed, unify => "D#4" actual
            let disp = letter+"b"+note.slice(1);
            let sem = letterToSemitone[disp];
            let sharpEquiv = semitoneToSharp[sem];
            return { display: disp, actual: sharpEquiv+note.slice(1) };
          }
        }
        return { display: note, actual: note };
      }

      // Build array of all notes from C2..C6
      const fullNoteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
      const allFullNotes = [];
      for (let oct=2; oct<=5; oct++){
        for (let n of fullNoteNames) {
          allFullNotes.push(n+oct);
        }
      }
      allFullNotes.push("C6");

      // Filter for staff ranges
      const allVals = allFullNotes.map(n => ({ note:n, val: noteToValue(n) }));
      const bassLowVal = noteToValue("C2");
      const bassHighVal= noteToValue("E4");
      const trebLowVal = noteToValue("A3");
      const trebHighVal= noteToValue("C6");
      const bassNotesArray = allVals.filter(o => o.val>=bassLowVal && o.val<=bassHighVal).map(o => o.note);
      const trebleNotesArray= allVals.filter(o => o.val>=trebLowVal && o.val<=trebHighVal).map(o => o.note);

      // Keyboard building
      function buildKeyboard(){
        const pianoKeysDiv = document.getElementById("pianoKeys");
        pianoKeysDiv.innerHTML="";
        // parse note
        function parseNote(noteName){
          const m = noteName.match(/([A-G]#?)(\d)/);
          return m ? { letter: m[1], octave: parseInt(m[2],10) } : null;
        }
        const whiteKeyOffsets = { "C":0,"D":60,"E":120,"F":180,"G":240,"A":300,"B":360 };
        const blackKeyOffsets = { "C#":40,"D#":100,"F#":220,"G#":280,"A#":340 };
        function isBlack(letter){ return letter.includes("#");}
        function getKeyX(letter,octave){
          const octIdx=octave-2;
          return isBlack(letter)
            ? octIdx*420 + blackKeyOffsets[letter]
            : octIdx*420 + whiteKeyOffsets[letter];
        }
        for (let note of allFullNotes){
          const p = parseNote(note);
          if (!p) continue;
          const xPos = getKeyX(p.letter, p.octave);
          const keyElem = document.createElement("div");
          keyElem.className = isBlack(p.letter) ? "black-key" : "white-key";
          keyElem.style.left = xPos+"px";
          keyElem.textContent = (note==="C4") ? "C4":"";
          keyElem.setAttribute("data-note",note);
          pianoKeysDiv.appendChild(keyElem);
        }
        // click
        pianoKeysDiv.querySelectorAll(".white-key, .black-key").forEach(elem=>{
          elem.addEventListener("click",function(){
            const playedNote = this.getAttribute("data-note");
            onUserPlay(playedNote);
          });
        });
      }

      // Generate 4 notes: 2 treble, 2 bass
      function generateNewSeries(){
        exerciseNotes=[];
        // 2 treble
        for (let i=0; i<2; i++){
          let base= trebleNotesArray[Math.floor(Math.random()*trebleNotesArray.length)];
          let acc = maybeAddAccidental(base);
          exerciseNotes.push({
            staff:"treble",
            spelledName: acc.display,
            actualName: acc.actual,
            correct:false,
            duration:"q"
          });
        }
        // 2 bass
        for (let i=0; i<2; i++){
          let base= bassNotesArray[Math.floor(Math.random()*bassNotesArray.length)];
          let acc= maybeAddAccidental(base);
          exerciseNotes.push({
            staff:"bass",
            spelledName: acc.display,
            actualName: acc.actual,
            correct:false,
            duration:"q"
          });
        }
        renderStaff();
        document.getElementById("message").textContent="";
      }

      // Render the staff
      function renderStaff(){
        const staffContainer = document.getElementById("staffContainer");
        staffContainer.innerHTML="";
        const renderer= new VF.Renderer(staffContainer, VF.Renderer.Backends.SVG);
        renderer.resize(520,300);
        const context= renderer.getContext();

        // Treble
        const staveTreble= new VF.Stave(10,20,500);
        staveTreble.addClef("treble"); // no armure
        staveTreble.setContext(context).draw();

        // Bass
        const staveBass= new VF.Stave(10,140,500);
        staveBass.addClef("bass");
        staveBass.setContext(context).draw();

        new VF.StaveConnector(staveTreble,staveBass)
          .setType(VF.StaveConnector.type.BRACE)
          .setContext(context)
          .draw();
        new VF.StaveConnector(staveTreble,staveBass)
          .setType(VF.StaveConnector.type.SINGLE_LEFT)
          .setContext(context)
          .draw();
        new VF.StaveConnector(staveTreble,staveBass)
          .setType(VF.StaveConnector.type.SINGLE_RIGHT)
          .setContext(context)
          .draw();

        const voiceTreble= new VF.Voice({num_beats:4, beat_value:4}).setStrict(false);
        const voiceBass  = new VF.Voice({num_beats:4, beat_value:4}).setStrict(false);

        // Build stave notes
        exerciseNotes.forEach(obj=>{
          let vexKey= convertNoteFormat(obj.spelledName);
          let staveNote= new VF.StaveNote({
            clef: obj.staff,
            keys: [vexKey],
            duration: obj.duration
          });
          // Show accidental if spelled includes # or b
          if (obj.spelledName.includes("#")) {
            staveNote.addAccidental(0,new VF.Accidental("#"));
          } else if (obj.spelledName.includes("b")){
            staveNote.addAccidental(0,new VF.Accidental("b"));
          }
          // offset bass
          if (obj.staff==="bass"){
            staveNote.setXShift(20);
          }
          if (obj.correct){
            staveNote.setStyle({ fillStyle:"green", strokeStyle:"green" });
          }
          if (obj.staff==="treble"){
            voiceTreble.addTickable(staveNote);
          } else {
            voiceBass.addTickable(staveNote);
          }
        });

        new VF.Formatter().joinVoices([voiceTreble]).format([voiceTreble],400);
        new VF.Formatter().joinVoices([voiceBass]).format([voiceBass],400);

        voiceTreble.draw(context, staveTreble);
        voiceBass.draw(context, staveBass);
      }

      // On user click note
      function onUserPlay(playedNote){
        synth.triggerAttackRelease(playedNote,"8n");
        let found=false;
        for (let obj of exerciseNotes){
          if (!obj.correct && obj.actualName===playedNote){
            obj.correct=true;
            found=true;
            break;
          }
        }
        if (found){
          renderStaff();
          if (exerciseNotes.every(o=>o.correct)){
            setTimeout(()=>{
              document.getElementById("message").textContent="Bravo ! Nouvelle série...";
              generateNewSeries();
            },1000);
          }
        } else {
          const msg=document.getElementById("message");
          msg.textContent="Cette note ne correspond pas (ou est déjà validée).";
          msg.style.color="red";
        }
      }

      // Quiz example
      window.checkQuizAnswer=function(questionId,answer){
        const correctAnswers={ 'q1':'G' };
        const resultElem= document.getElementById(questionId);
        if (answer===correctAnswers[questionId]){
          resultElem.textContent="Correct !";
          resultElem.style.color="green";
        } else {
          resultElem.textContent="Incorrect, essayez encore.";
          resultElem.style.color="red";
        }
      };

      // Build keyboard now
      buildKeyboard();

      // Tab switching
      const theorySection= document.getElementById("theorySection");
      const practiceSection=document.getElementById("practiceSection");
      const theoryTab= document.getElementById("theoryTab");
      const practiceTab=document.getElementById("practiceTab");

      theoryTab.addEventListener("click",function(){
        theorySection.classList.add("active");
        practiceSection.classList.remove("active");
      });

      practiceTab.addEventListener("click", async function(){
        await Tone.start();
        theorySection.classList.remove("active");
        practiceSection.classList.add("active");
        generateNewSeries();
      });

      // "Nouvelle Série" button
      document.getElementById("newExerciseBtn").addEventListener("click", generateNewSeries);
    });
  </script>
</body>
</html>
